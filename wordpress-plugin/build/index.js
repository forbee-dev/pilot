(()=>{"use strict";const e=window.React,o=window.wp.blocks,n=window.wp.element,t=window.wp.blockEditor,r=window.wp.components,s=window.wp.i18n,c=window.microfeConfig||{apiUrl:"http://localhost:3000"};(0,o.registerBlockType)("microfe/react-component",{title:(0,s.__)("React Component","microfe-components"),icon:"admin-plugins",category:"widgets",attributes:{component:{type:"string",default:""},version:{type:"string",default:""},props:{type:"object",default:{}}},edit:({attributes:o,setAttributes:l})=>{const[a,i]=(0,n.useState)([]),[p,m]=(0,n.useState)(!1),[u,d]=(0,n.useState)(null),[f,h]=(0,n.useState)(null),[g,v]=(0,n.useState)(""),[E,w]=(0,n.useState)(!1),[b,S]=(0,n.useState)(null),[y,C]=(0,n.useState)(o.props||{}),_=(0,t.useBlockProps)({className:"microfe-component-block"});(0,n.useEffect)(()=>{m(!0),d(null);const e=c.apiUrl||"http://localhost:3000",o=`${e}/api/components`;console.log("Fetching components from:",o),fetch(o).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{console.log("Components loaded:",e),Array.isArray(e)?i(e):(console.error("Unexpected response format:",e),d("Invalid response format from API"),i([])),m(!1)}).catch(o=>{console.error("Error fetching components:",o),console.error("API URL:",e),d(`Failed to load components: ${o.message}. Check API URL in Settings â†’ MicroFE`),i([]),m(!1)})},[]),(0,n.useEffect)(()=>{o.component&&fetch(`${c.apiUrl}/api/components/${o.component}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()}).then(e=>{h(e);const n=o.version||e.latestVersion;l({version:n});const t=e.versions.find(e=>e.version===n);t&&t.propsSchema&&S(t.propsSchema)}).catch(e=>{console.error("Error fetching component details:",e)})},[o.component]),(0,n.useEffect)(()=>{o.component&&o.version&&k()},[o.component,o.version,y]);const k=()=>{if(!o.component||!o.version)return;w(!0);const e=encodeURIComponent(JSON.stringify(y)),n=`${c.apiUrl}/api/render/${o.component}/${o.version}?props=${e}`;fetch(n).then(e=>e.json()).then(e=>{v(e.html||""),w(!1)}).catch(e=>{console.error("Error rendering preview:",e),w(!1)})},$=(e,o)=>{const n={...y,[e]:o};C(n),l({props:n})};return(0,e.createElement)("div",{..._},(0,e.createElement)(t.InspectorControls,null,(0,e.createElement)(r.PanelBody,{title:(0,s.__)("Component Settings","microfe-components")},u&&(0,e.createElement)("div",{style:{padding:"0.5rem",backgroundColor:"#f8d7da",color:"#721c24",borderRadius:"4px",marginBottom:"1rem",fontSize:"0.875rem"}},u),p?(0,e.createElement)("div",null,(0,e.createElement)(r.Spinner,null),(0,e.createElement)("p",{style:{fontSize:"0.875rem",marginTop:"0.5rem"}},"Loading components...")):0!==a.length||u?(0,e.createElement)(r.SelectControl,{label:(0,s.__)("Component","microfe-components"),value:o.component,options:[{label:(0,s.__)("Select a component...","microfe-components"),value:""},...a.map(e=>({label:`${e.name} (${e.latestVersion})`,value:e.slug}))],onChange:e=>{l({component:e,version:"",props:{}}),C({}),h(null),S(null)}}):(0,e.createElement)("p",{style:{fontSize:"0.875rem",color:"#666"}},"No components available. Make sure components are uploaded to MicroFE."),f&&(0,e.createElement)(r.SelectControl,{label:(0,s.__)("Version","microfe-components"),value:o.version,options:f.versions.map(e=>({label:e.version,value:e.version})),onChange:e=>{if(l({version:e}),f){const o=f.versions.find(o=>o.version===e);o&&o.propsSchema&&S(o.propsSchema)}}}),b&&b.properties&&(0,e.createElement)(r.PanelBody,{title:(0,s.__)("Props","microfe-components"),initialOpen:!0},Object.entries(b.properties).map(([o,n])=>((o,n)=>{const t=n.type||"string",s=y[o]||"";switch(t){case"number":return(0,e.createElement)(r.TextControl,{key:o,label:o,type:"number",value:s,onChange:e=>$(o,parseFloat(e)||0)});case"boolean":return(0,e.createElement)("div",{key:o,style:{marginBottom:"1rem"}},(0,e.createElement)("label",null,(0,e.createElement)("input",{type:"checkbox",checked:s||!1,onChange:e=>$(o,e.target.checked)}),o));default:return(0,e.createElement)(r.TextControl,{key:o,label:o,value:s,onChange:e=>$(o,e)})}})(o,n))))),(0,e.createElement)("div",{style:{padding:"1rem",border:"1px dashed #ccc",minHeight:"100px"}},o.component?E?(0,e.createElement)(r.Spinner,null):g?(0,e.createElement)("div",{dangerouslySetInnerHTML:{__html:g}}):(0,e.createElement)("p",null,(0,s.__)("Loading preview...","microfe-components")):(0,e.createElement)("p",null,(0,s.__)("Select a component from the sidebar to preview it.","microfe-components"))))},save:()=>null})})();